<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBB Beverage - AI Document Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #111827, #000000);
            min-height: 100vh;
        }
        .drop-zone {
            border: 2px dashed #4B5563;
            transition: all 0.3s ease;
        }
        .drop-zone:hover {
            border-color: #84cc16;
            background-color: rgba(132, 204, 22, 0.1);
        }
        .drop-zone.dragover {
            border-color: #84cc16;
            background-color: rgba(132, 204, 22, 0.1);
        }
        .log-entry {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.875rem;
            line-height: 1.25rem;
            padding: 0.25rem 0;
        }
        .log-info { color: #84cc16; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #ef4444; }
        .log-success { color: #84cc16; }
        .analyze-btn {
            background: linear-gradient(45deg, #84cc16, #65a30d);
            box-shadow: 0 0 15px rgba(132, 204, 22, 0.3);
            transition: all 0.3s ease;
        }
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(132, 204, 22, 0.5);
        }
        .terminal {
            background: #000;
            border: 1px solid #333;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .terminal-header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 8px 12px;
            border-radius: 6px 6px 0 0;
        }
        .terminal-body {
            padding: 12px;
            height: 300px;
            overflow-y: auto;
        }
        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .dot-red { background: #ff5f56; }
        .dot-yellow { background: #ffbd2e; }
        .dot-green { background: #27c93f; }
        .dashboard-info {
            background: rgba(132, 204, 22, 0.1);
            border: 1px solid #84cc16;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }
        .progress-container {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .progress-bar {
            height: 10px;
            background: rgba(31, 41, 55, 0.8);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #84cc16, #65a30d);
            border-radius: 5px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .status-messages-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
            padding: 12px;
            background: rgba(31, 41, 55, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .status-messages-container::-webkit-scrollbar {
            width: 8px;
        }
        .status-messages-container::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 4px;
        }
        .status-messages-container::-webkit-scrollbar-thumb {
            background: rgba(132, 204, 22, 0.3);
            border-radius: 4px;
        }
        .status-messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(132, 204, 22, 0.5);
        }
        .status-text {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.875rem;
            line-height: 1.25rem;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 4px 0;
            background: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .status-text:hover {
            transform: translateX(5px);
            background: rgba(31, 41, 55, 0.7);
        }
        .status-info { color: #84cc16; }
        .status-warning { color: #fbbf24; }
        .status-error { color: #ef4444; }
        .status-success { color: #84cc16; }
        .analysis-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .summary-card {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .summary-title {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 8px;
        }
        .summary-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #84cc16;
        }
        .summary-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 8px;
            color: #84cc16;
        }
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 24px 0;
            position: relative;
        }
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(31, 41, 55, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            border: 2px solid #4B5563;
            transition: all 0.3s ease;
        }
        .step-icon.active {
            border-color: #84cc16;
            background: rgba(132, 204, 22, 0.2);
        }
        .step-icon.completed {
            border-color: #84cc16;
            background: #84cc16;
        }
        .step-label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
        }
        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #4B5563;
            z-index: 0;
        }
        .progress-line-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #84cc16;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <img src="/static/images/BBB Logo.png" alt="BBB Beverage Logo" class="mx-auto h-24 mb-4">
            <h1 class="text-4xl font-bold mb-2">BBB Beverage</h1>
            <p class="text-xl text-gray-400">AI Document Analyzer</p>
        </header>

        <!-- Main Content -->
        <div class="max-w-3xl mx-auto">
            <!-- Upload Section -->
            <div class="bg-zinc-800 rounded-lg shadow-xl p-6 mb-8">
                <form id="uploadForm" class="space-y-4" enctype="multipart/form-data">
                    <div class="drop-zone rounded-lg p-8 text-center cursor-pointer" id="dropZone">
                        <div class="space-y-2">
                            <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <div class="text-gray-300">
                                <span class="font-medium">Click to upload</span> or drag and drop
                            </div>
                            <p class="text-sm text-gray-400">Excel or CSV files only</p>
                        </div>
                        <input type="file" id="fileInput" name="file" class="hidden" accept=".xlsx,.xls,.csv">
                    </div>
                    
                    <!-- File Info Display -->
                    <div id="fileInfo" class="hidden">
                        <div class="flex items-center justify-between bg-zinc-700 rounded-lg p-3">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="file-check-2" class="h-6 w-6 text-lime-500"></i>
                                <div>
                                    <p id="fileName" class="text-sm font-medium text-gray-100"></p>
                                    <p id="fileSize" class="text-xs text-gray-400"></p>
                                </div>
                            </div>
                            <button type="button" id="removeFile" class="text-gray-400 hover:text-gray-300">
                                <i data-lucide="x" class="h-5 w-5"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" id="analyzeBtn" class="analyze-btn w-full text-gray-900 font-semibold py-3 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Analyze File
                    </button>
                </form>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="bg-zinc-800 rounded-lg shadow-xl p-6 mb-8 hidden">
                <h2 class="text-xl font-semibold text-gray-100 mb-4">Processing Status</h2>
                <div class="progress-container">
                    <div class="progress-steps">
                        <div class="progress-line">
                            <div id="progressLineFill" class="progress-line-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon" id="step1">
                                <i data-lucide="upload" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <span class="step-label">Upload</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon" id="step2">
                                <i data-lucide="file-check" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <span class="step-label">Validation</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon" id="step3">
                                <i data-lucide="settings" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <span class="step-label">Processing</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon" id="step4">
                                <i data-lucide="check-circle" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <span class="step-label">Complete</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-300">Processing File</span>
                        <span id="progressPercent" class="text-sm font-medium text-gray-300">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <div class="status-messages-container">
                        <div id="statusMessages" class="space-y-2"></div>
                    </div>

                    <div class="analysis-summary">
                        <div class="summary-card">
                            <i data-lucide="file-text" class="summary-icon"></i>
                            <div class="summary-title">Total Rows</div>
                            <div class="summary-value" id="totalRows">0</div>
                        </div>
                        <div class="summary-card">
                            <i data-lucide="alert-triangle" class="summary-icon"></i>
                            <div class="summary-title">Warnings</div>
                            <div class="summary-value" id="totalWarnings">0</div>
                        </div>
                        <div class="summary-card">
                            <i data-lucide="check-circle" class="summary-icon"></i>
                            <div class="summary-title">Success Rate</div>
                            <div class="summary-value" id="successRate">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="bg-zinc-800 rounded-lg shadow-xl p-6 mb-8 hidden">
                <h2 class="text-xl font-semibold text-gray-100 mb-4">Analysis Results</h2>
                <div id="results" class="text-gray-300"></div>
                <div id="downloadSection" class="mt-4 hidden">
                    <a id="downloadLink" href="#" class="inline-flex items-center space-x-2 bg-lime-500 text-gray-900 font-semibold py-2 px-4 rounded-lg hover:bg-lime-600 transition duration-200">
                        <i data-lucide="download" class="h-5 w-5"></i>
                        <span>Download Output with Error Highlights</span>
                    </a>
                </div>
                <div class="dashboard-info">
                    <h3 class="text-lg font-semibold text-lime-500 mb-2">Validation Dashboard</h3>
                    <p class="text-sm text-gray-300 mb-2">The output file includes a validation dashboard that shows:</p>
                    <ul class="text-sm text-gray-300 list-disc list-inside space-y-1">
                        <li>Cells highlighted in yellow need manual review</li>
                        <li>Validation messages at the bottom of the sheet</li>
                        <li>Detailed error tracking in the Debug_Log tab</li>
                        <li>Confidence scores for each field</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-400 text-sm">
            Powered by TrustBodhi AI â€¢ Internal Tool for BBB Beverage Team
        </footer>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // File Upload Handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFile = document.getElementById('removeFile');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const progressSection = document.getElementById('progressSection');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressPercent = document.getElementById('progressPercent');
        const statusMessages = document.getElementById('statusMessages');
        const resultsSection = document.getElementById('resultsSection');
        const progressLineFill = document.getElementById('progressLineFill');

        // Drag and drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) handleFile(files[0]);
        });

        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        removeFile.addEventListener('click', () => {
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            analyzeBtn.disabled = true;
        });

        function handleFile(file) {
            if (!file.name.match(/\.(csv|xlsx|xls)$/i)) {
                alert('Please upload a CSV or Excel file');
                return;
            }

            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('hidden');
            analyzeBtn.disabled = false;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateProgress(percent, message, type = 'info') {
            progressBarFill.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            progressLineFill.style.width = `${percent}%`;
            
            // Update step icons
            const steps = document.querySelectorAll('.step-icon');
            steps.forEach((step, index) => {
                if (percent >= (index + 1) * 25) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (percent >= index * 25) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });
            
            const messageElement = document.createElement('div');
            messageElement.className = `status-text status-${type}`;
            messageElement.textContent = message;
            messageElement.title = message; // Add tooltip for truncated text
            statusMessages.appendChild(messageElement);
            
            // Scroll to bottom of status messages container
            const container = document.querySelector('.status-messages-container');
            container.scrollTop = container.scrollHeight;

            // Update summary cards
            if (message.includes('Processing row')) {
                const totalRows = parseInt(document.getElementById('totalRows').textContent) + 1;
                document.getElementById('totalRows').textContent = totalRows;
            }
            if (message.includes('WARNING')) {
                const totalWarnings = parseInt(document.getElementById('totalWarnings').textContent) + 1;
                document.getElementById('totalWarnings').textContent = totalWarnings;
            }
            if (percent === 100) {
                const totalRows = parseInt(document.getElementById('totalRows').textContent);
                const totalWarnings = parseInt(document.getElementById('totalWarnings').textContent);
                const successRate = Math.round(((totalRows - totalWarnings) / totalRows) * 100);
                document.getElementById('successRate').textContent = `${successRate}%`;
            }
        }

        // Form Submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) return;

            // Reset UI
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            statusMessages.innerHTML = '';
            progressBarFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressLineFill.style.width = '0%';
            document.getElementById('totalRows').textContent = '0';
            document.getElementById('totalWarnings').textContent = '0';
            document.getElementById('successRate').textContent = '0%';
            
            // Add initial status message
            updateProgress(0, 'ðŸ“¤ Starting file upload...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            try {
                // Simulate progress updates
                const progressInterval = setInterval(() => {
                    const currentProgress = parseInt(progressBarFill.style.width) || 0;
                    if (currentProgress < 90) {
                        const newProgress = Math.min(currentProgress + Math.random() * 5, 90);
                        updateProgress(Math.round(newProgress), 'ðŸ”„ Processing data...', 'info');
                    }
                }, 2000);

                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                updateProgress(100, 'âœ… Processing complete!', 'success');

                // Always try to download the file, even if response is not OK
                const blob = await response.blob();
                const link = document.createElement("a");
                link.href = window.URL.createObjectURL(blob);
                link.download = "output_60vines.xlsx";
                document.body.appendChild(link);
                link.click();
                link.remove();

                // Show results section
                resultsSection.classList.remove('hidden');
                updateProgress(100, 'ðŸ“¥ Download started automatically', 'success');

            } catch (error) {
                updateProgress(100, `âŒ Error: ${error.message}`, 'error');
                console.error('Upload error:', error);
            }
        });
    </script>
</body>
</html> 